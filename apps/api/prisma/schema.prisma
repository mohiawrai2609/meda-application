// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Organization {
  id        String   @id @default(uuid())
  name      String
  settings  String     @default("{}")  // SLA timers, reminder config, branding
  createdAt DateTime @default(now())
  users     User[]
  loans     Loan[]
}

model User {
  id             String       @id @default(uuid())
  email          String       @unique
  passwordHash   String
  name           String
  role           String       @default("PROCESSOR")
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime     @default(now())
  exceptions     Exception[]  @relation("AssignedProcessor")
  auditLogs      AuditLog[]
}

// enum UserRole {
//   ADMIN
//   PROCESSOR
//   MANAGER
// }

model Loan {
  id              String       @id @default(uuid())
  loanNumber      String       @unique
  borrowerName    String
  borrowerEmail   String
  borrowerPhone   String?
  propertyAddress String?
  loanAmount      Float?
  loanType        String?      // Conventional, FHA, VA, USDA
  losReferenceId  String?      // ID in the LOS system
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  exceptions      Exception[]
}

model Exception {
  id                String          @id @default(uuid())
  loanId            String
  loan              Loan            @relation(fields: [loanId], references: [id])
  assignedToId      String?
  assignedTo        User?           @relation("AssignedProcessor", fields: [assignedToId], references: [id])
  
  // Exception details
  exceptionType     String
  documentType      String
  description       String          // Human-readable description
  severity          String        @default("MEDIUM")
  
  // Status tracking
  status            String @default("OPEN")
  attemptCount      Int             @default(0)
  maxAttempts       Int             @default(4)
  
  // SLA tracking
  slaDeadline       DateTime?
  firstContactAt    DateTime?
  resolvedAt        DateTime?
  escalatedAt       DateTime?
  
  // Relationships
  communications    Communication[]
  documents         Document[]
  auditLogs         AuditLog[]
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@index([status])
  @@index([loanId])
  @@index([slaDeadline])
}

// Removed enums for SQLite compatibility

model Communication {
  id            String            @id @default(uuid())
  exceptionId   String
  exception     Exception         @relation(fields: [exceptionId], references: [id])
  
  channel       String       @default("EMAIL")
  direction     String     // OUTBOUND (to borrower) or INBOUND (from borrower)
  messageType   String
  
  subject       String?
  body          String            // The actual message content
  metadata      String?             // SendGrid message ID, delivery status, etc.
  
  sentAt        DateTime?
  deliveredAt   DateTime?
  openedAt      DateTime?
  clickedAt     DateTime?
  bouncedAt     DateTime?
  
  createdAt     DateTime          @default(now())
  
  @@index([exceptionId])
}

// Removed enums for SQLite compatibility

model Document {
  id            String          @id @default(uuid())
  exceptionId   String
  exception     Exception       @relation(fields: [exceptionId], references: [id])
  
  fileName      String
  fileType      String          // pdf, jpg, png
  fileSize      Int
  storageKey    String          // S3 key
  storageUrl    String          // Presigned URL (temporary)
  
  // Validation results
  validationStatus String @default("PENDING")
  validationResult String?         // Detailed validation output from AI
  validationErrors String?       // List of specific issues found (JSON string)
  
  uploadedAt    DateTime        @default(now())
  validatedAt   DateTime?
  
  @@index([exceptionId])
}

// Removed enum for SQLite compatibility

model AuditLog {
  id            String   @id @default(uuid())
  exceptionId   String?
  exception     Exception? @relation(fields: [exceptionId], references: [id])
  userId        String?
  user          User?    @relation(fields: [userId], references: [id])
  
  action        String   // e.g., "exception.created", "document.validated", "status.changed"
  details       String?    // Additional context
  
  createdAt     DateTime @default(now())
  
  @@index([exceptionId])
  @@index([createdAt])
}
